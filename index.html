<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<title>Гра з боєм і ворогами</title>
<style>
  body { margin:0; overflow:hidden; background: #333; font-family: monospace; }
  canvas { display:block; margin: 0 auto; background: #87ceeb; }
  #info { color: white; text-align: center; margin: 10px; }
</style>
</head>
<body>

<canvas id="game" width="800" height="400"></canvas>
<div id="info">Рух: WASD або стрілки. Ліва кнопка миші — удар.</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

const tileSize = 40;
const cols = Math.floor(canvas.width / tileSize);
const rows = Math.floor(canvas.height / tileSize);

const AIR = 0, GROUND = 1;
const colors = {
  [AIR]: null,
  [GROUND]: '#654321'
};

let keys = {};
window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

let mouseDown = false;
window.addEventListener('mousedown', e => mouseDown = true);
window.addEventListener('mouseup', e => mouseDown = false);

// Простий світ — земля по низу
let world = [];
for(let r=0; r<rows; r++) {
  world[r] = [];
  for(let c=0; c<cols; c++) {
    if (r >= rows - 2) world[r][c] = GROUND; else world[r][c] = AIR;
  }
}

const player = {
  x: tileSize * 2,
  y: (rows - 3) * tileSize,
  w: 30,
  h: 35,
  vx: 0,
  vy: 0,
  speed: 4,
  grounded: false,
  hp: 100,
  attackCooldown: 0,
  facing: 1 // 1 = вправо, -1 = вліво
};

function isSolid(r,c) {
  return r>=0 && r<rows && c>=0 && c<cols && world[r][c] === GROUND;
}

function collideRect(a,b) {
  return !(a.x + a.w < b.x || a.x > b.x + b.w ||
           a.y + a.h < b.y || a.y > b.y + b.h);
}

const enemies = [];
function spawnEnemy(x,y) {
  enemies.push({
    x, y, w: 30, h: 35, vx: 1, hp: 20, attackCooldown: 0
  });
}

// Спавнимо кілька ворогів
spawnEnemy(400, (rows - 3) * tileSize);
spawnEnemy(600, (rows - 3) * tileSize);

function updatePlayer() {
  // Рух
  player.vx = 0;
  if(keys['a'] || keys['arrowleft']) { player.vx = -player.speed; player.facing = -1; }
  if(keys['d'] || keys['arrowright']) { player.vx = player.speed; player.facing = 1; }

  // Стрибок
  if((keys['w'] || keys['arrowup'] || keys[' ']) && player.grounded) {
    player.vy = -15;
    player.grounded = false;
  }

  // Гравітація
  player.vy += 1;
  if(player.vy > 20) player.vy = 20;

  // Горизонтальна колізія
  player.x += player.vx;
  let leftCol = Math.floor(player.x / tileSize);
  let rightCol = Math.floor((player.x + player.w) / tileSize);
  let topRow = Math.floor(player.y / tileSize);
  let bottomRow = Math.floor((player.y + player.h) / tileSize);

  if(player.vx > 0) {
    if(isSolid(topRow,rightCol) || isSolid(bottomRow,rightCol)) {
      player.x = rightCol * tileSize - player.w - 0.01;
    }
  } else if(player.vx < 0) {
    if(isSolid(topRow,leftCol) || isSolid(bottomRow,leftCol)) {
      player.x = (leftCol + 1) * tileSize + 0.01;
    }
  }

  // Вертикальна колізія
  player.y += player.vy;
  topRow = Math.floor(player.y / tileSize);
  bottomRow = Math.floor((player.y + player.h) / tileSize);

  if(player.vy > 0) {
    if(isSolid(bottomRow,leftCol) || isSolid(bottomRow,rightCol)) {
      player.y = bottomRow * tileSize - player.h - 0.01;
      player.vy = 0;
      player.grounded = true;
    } else {
      player.grounded = false;
    }
  } else if(player.vy < 0) {
    if(isSolid(topRow,leftCol) || isSolid(topRow,rightCol)) {
      player.y = (topRow + 1) * tileSize + 0.01;
      player.vy = 0;
    }
  }

  // Обмеження в межах екрану
  if(player.x < 0) player.x = 0;
  if(player.x + player.w > canvas.width) player.x = canvas.width - player.w;
  if(player.y > canvas.height) {
    player.hp = 0;
  }

  // Атакуємо
  if(player.attackCooldown > 0) player.attackCooldown--;

  if(mouseDown && player.attackCooldown === 0) {
    player.attackCooldown = 20; // затримка між ударами
    attack();
  }
}

function attack() {
  // Область атаки перед гравцем
  const attackRange = {
    x: player.facing === 1 ? player.x + player.w : player.x - 40,
    y: player.y,
    w: 40,
    h: player.h
  };
  // Візуально показати удар (плюс можна додати анімацію)
  ctx.fillStyle = 'rgba(255,255,0,0.5)';
  ctx.fillRect(attackRange.x, attackRange.y, attackRange.w, attackRange.h);

  // Перевіряємо зіткнення з ворогами
  enemies.forEach(e => {
    if(e.hp > 0 && collideRect(attackRange, e)) {
      e.hp -= 10;
    }
  });
}

function updateEnemies() {
  enemies.forEach(e => {
    if(e.hp <= 0) return;

    // Рух ворога: ходить вліво-вправо
    e.x += e.vx;

    // Зміна напрямку при зіткненні зі стіною або межами
    if(e.x < 0 || e.x + e.w > canvas.width) e.vx *= -1;

    // Атакує гравця, якщо поруч і cooldown минув
    if(collideRect(e, player)) {
      if(e.attackCooldown === 0) {
        player.hp -= 5;
        e.attackCooldown = 50;
      }
    }
    if(e.attackCooldown > 0) e.attackCooldown--;
  });

  // Видалення мертвих ворогів (щоб не рендерити)
  for(let i = enemies.length -1; i >=0; i--) {
    if(enemies[i].hp <= 0) enemies.splice(i,1);
  }
}

function drawWorld() {
  for(let r=0; r<rows; r++) {
    for(let c=0; c<cols; c++) {
      if(world[r][c] === GROUND) {
        ctx.fillStyle = colors[GROUND];
        ctx.fillRect(c*tileSize, r*tileSize, tileSize, tileSize);
      }
    }
  }
}

function drawPlayer() {
  ctx.fillStyle = '#ff0';
  ctx.fillRect(player.x, player.y, player.w, player.h);
}

function drawEnemies() {
  enemies.forEach(e => {
    if(e.hp > 0) {
      ctx.fillStyle = 'red';
      ctx.fillRect(e.x, e.y, e.w, e.h);
      // Малюємо шкалу здоров'я
      ctx.fillStyle = 'green';
      ctx.fillRect(e.x, e.y - 6, e.w * (e.hp/20), 4);
    }
  });
}

function drawHP() {
  ctx.fillStyle = 'white';
  ctx.font = '18px monospace';
  ctx.fillText('Здоров\'я: ' + player.hp, 10, 25);
}

function gameOver() {
  ctx.fillStyle = 'black';
  ctx.globalAlpha = 0.7;
  ctx.fillRect(0,0,canvas.width, canvas.height);
  ctx.globalAlpha = 1;
  ctx.fillStyle = 'red';
  ctx.font = '48px monospace';
  ctx.textAlign = 'center';
  ctx.fillText('GAME OVER', canvas.width/2, canvas.height/2);
}

function update() {
  if(player.hp <= 0) {
    draw();
    gameOver();
    return;
  }
  updatePlayer();
  updateEnemies();
  draw();
  requestAnimationFrame(update);
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawWorld();
  drawPlayer();
  drawEnemies();
  drawHP();
}

update();

</script>

</body>
</html>
